<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bandhan Messenger</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-screen flex bg-gray-100">

  <!-- Sidebar -->
  <aside class="w-1/4 bg-white shadow flex flex-col">
    <div class="p-4 border-b">
      <h2 class="text-lg font-bold mb-2">New User</h2>
      <input id="username" placeholder="নাম" class="w-full p-2 border rounded mb-2"/>
      <input id="mobile" placeholder="মোবাইল" class="w-full p-2 border rounded mb-2"/>
      <button onclick="createUser()" class="w-full bg-indigo-600 text-white p-2 rounded mb-1 hover:bg-indigo-700 transition">Save</button>
      <p id="userMsg" class="text-green-600 text-sm mt-1"></p>
    </div>
    <div id="userList" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
  </aside>

  <!-- Chat Area -->
  <main class="flex-1 flex flex-col">
    <header id="chatHeader" class="p-4 bg-indigo-600 text-white font-bold shadow">
      Select One User
    </header>
    <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-2"></div>
    <div class="flex p-4 bg-gray-200">
      <input id="messageInput" type="text" placeholder="মেসেজ লিখুন..." class="flex-1 p-2 rounded-l border"/>
      <button onclick="sendMessage()" class="bg-indigo-600 text-white px-4 rounded-r hover:bg-indigo-700 transition">Send</button>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjyTMgP5mNf3ZMI-ZXKnzu0MP1Uz9omec",
      authDomain: "bandhan-chat.firebaseapp.com",
      projectId: "bandhan-chat",
      storageBucket: "bandhan-chat.firebasestorage.app",
      messagingSenderId: "852469205550",
      appId: "1:852469205550:web:a7e1c1723477c93169adbf",
      measurementId: "G-QLEYD6WGPY"
    };

    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;
    let activeChatUser = null;

    function createUser() {
      const username = document.getElementById("username").value.trim();
      const mobile = document.getElementById("mobile").value.trim();
      if(!username || !mobile){ alert("নাম ও মোবাইল দিন!"); return; }
      db.collection("users").add({ username, mobile })
        .then(docRef=>{
          currentUser = { id: docRef.id, username };
          document.getElementById("userMsg").innerText = "✅ ইউজার তৈরি সফল!";
          loadUsers();
        });
    }

    function loadUsers() {
      db.collection("users").orderBy("username").onSnapshot(snapshot=>{
        const list = document.getElementById("userList");
        list.innerHTML="";
        snapshot.forEach(doc=>{
          const u = doc.data();
          if(currentUser && doc.id === currentUser.id) return;
          const div = document.createElement("div");
          div.className = "flex items-center p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer shadow-sm";
          div.innerHTML = `<div class="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center font-bold text-white">${u.username.charAt(0).toUpperCase()}</div>
                           <div class="ml-2"><p class="font-semibold">${u.username}</p><p class="text-xs text-gray-500">${u.mobile}</p></div>`;
          div.onclick = ()=> openChat(doc.id, u.username);
          list.appendChild(div);
        });
      });
    }

    function openChat(userId, username){
      activeChatUser = { id:userId, username };
      document.getElementById("chatHeader").innerText = "চ্যাট: "+username;
      loadMessages();
    }

    function loadMessages(){
      if(!currentUser || !activeChatUser) return;
      const chatId = [currentUser.id, activeChatUser.id].sort().join("_");
      db.collection("messages").doc(chatId).collection("msgs")
        .orderBy("time","asc")
        .onSnapshot(snap=>{
          const box = document.getElementById("messages");
          box.innerHTML="";
          snap.forEach(doc=>{
            const d = doc.data();
            const div = document.createElement("div");
            div.className = "p-2 rounded max-w-xs " + (d.sender===currentUser.username ? "bg-indigo-100 ml-auto text-right" : "bg-white mr-auto text-left shadow-sm");
            div.innerText = d.sender+": "+d.text;
            box.appendChild(div);
          });
          box.scrollTop = box.scrollHeight;
        });
    }

    function sendMessage(){
      const text = document.getElementById("messageInput").value.trim();
      if(!text || !currentUser || !activeChatUser){ alert("প্রথমে ইউজার তৈরি করুন ও মেসেজ লিখুন!"); return; }
      const chatId = [currentUser.id, activeChatUser.id].sort().join("_");
      db.collection("messages").doc(chatId).collection("msgs").add({
        sender: currentUser.username,
        text,
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById("messageInput").value="";
    }

    loadUsers();
  </script>
</body>
</html>
